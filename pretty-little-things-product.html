<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/pretty.css">
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script>
        // Configuración de Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyCtZxlonTfLpU_5-HMuf6RdDmbJy3iMdPU",
            authDomain: "trend-vr-demo.firebaseapp.com",
            projectId: "trend-vr-demo",
            storageBucket: "trend-vr-demo.appspot.com",
            messagingSenderId: "383550694303",
            appId: "1:383550694303:web:362cf770089f4008e4d3aa"
        };
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
</head>

<body>
    <div id="product-info"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        function generateProductHTML(product, lastImage) {
            return `
                <div class="product-gallery">
                ${product.gallery.map(image => `<img src="${image.url}" alt="${image.alt}">`).join('')}
                </div>
                <div class="product-content">
                    <a href="#" id="generate" class="generate-ai">Try it on yourself!</a>
                    <p>${product.pricing.currency} $${product.pricing.regular_price}</del>
                    <del>${product.pricing.currency} $${product.pricing.sale_price}</p>
                    <h1>${product.name}</h1>
                    <p>${product.description}</p>
                    <h2>Colors</h2>
                    <ul>
                    ${product.colors.map(color => `<li>${color.name} (${color.hex})</li>`).join('')}
                    </ul>
                    <h2>Sizes</h2>
                    <ul>
                    ${product.sizes.map(size => `<li>${size}</li>`).join('')}
                    </ul>
                    <h2>Details</h2>
                    <ul>
                    ${product.details.material.map(material => `<li>${material}</li>`).join('')}
                    </ul>
                    <h2>Care Instructions</h2>
                    <ul>
                    ${product.details.care_instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                    </ul>
                </div>

    `;
        }

        document.addEventListener('DOMContentLoaded', function () {
            async function loadProductData() {
                const { category, type, id } = getQueryParams();
                if (category && type && id) {
                    try {
                        const response = await fetch(`assets/fakeData/${category}.json`);
                        const data = await response.json();
                        const product = data.products.find(item => item.id == id);
                        if (product) {
                            const galleryLength = product.gallery.length;
                            const lastImage = galleryLength > 0 ? product.gallery[galleryLength - 1].url : '';
                            document.getElementById('product-info').innerHTML = generateProductHTML(product, lastImage);
                            addGenerateListener(type, lastImage);  // Llamar a la función para añadir el listener
                        } else {
                            document.getElementById('product-info').innerHTML = `<p>Product not found</p>`;
                        }
                    } catch (error) {
                        console.error('Error loading JSON file:', error);
                        document.getElementById('product-info').innerHTML = `<p>Error loading product data</p>`;
                    }
                } else {
                    document.getElementById('product-info').innerHTML = `<p>Invalid parameters</p>`;
                }
            }

            function addGenerateListener(type, lastImageUrl) {
                const generateButton = document.getElementById('generate');
                if (generateButton) {
                    generateButton.addEventListener('click', async (event) => {
                        event.preventDefault();
                        const userImageProfile = localStorage.getItem('userImageProfile');

                        const url = "http://4.227.140.241:2000/trendvr-ai-service/vto/generate";
                        const headers = { "Content-Type": "application/json" };
                        const data = JSON.stringify({
                            human_image_url: userImageProfile,
                            cloth_image_url: lastImageUrl,
                            body_part: type
                        });

                        try {
                            const response = await fetch(url, { method: 'POST', headers: headers, body: data });
                            const responseData = await response.json();
                            if (responseData && responseData.image) {
                                const newImgSrc = `data:image/jpeg;base64,${responseData.image}`;
                                // Asegúrate de que se envía sin el prefijo al método de carga
                                uploadImageToFirebase(responseData.image);
                                const gallery = document.querySelector('.product-gallery');
                                const newImgElement = document.createElement('img');
                                newImgElement.src = newImgSrc;
                                gallery.appendChild(newImgElement);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    });
                } else {
                    console.error('No se encontró el botón generate');
                }
            }

            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    category: params.get('category'),
                    type: params.get('type'),
                    id: params.get('id')
                };
            }

            loadProductData();
        });


        function uploadImageToFirebase(imageBase64) {
            // Retrieve the userID from localStorage
            var userId = localStorage.getItem('userID');

            // Check if the userId is available
            if (!userId) {
                console.error("No user ID provided");
                return;
            }

            // Remove the data URL prefix if present
            var base64Cleaned = imageBase64.replace(/^data:image\/(png|jpeg|jpg);base64,/, '');

            var byteString;
            try {
                byteString = atob(base64Cleaned);
            } catch (e) {
                console.error("Failed to decode base64 string:", e);
                return; // Stops execution if there is an error
            }

            var ab = new ArrayBuffer(byteString.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            var blob = new Blob([ab], { type: 'image/jpeg' }); // Ensure the correct type is specified

            var storage = firebase.storage();
            var storageRef = storage.ref();
            // Modify the path to include the userId
            var imageRef = storageRef.child(`users/${userId}/generated-images/${new Date().getTime()}.jpeg`);

            var uploadTask = imageRef.put(blob);

            uploadTask.on('state_changed', function (snapshot) {
                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
            }, function (error) {
                console.error('Upload failed:', error);
            }, function () {
                uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
                    console.log('File available at', downloadURL);
                });
            });
        }

    </script>
</body>

</html>