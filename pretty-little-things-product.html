<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/pretty.css">
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Feather Icons -->
    <script>
        // Configuración de Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyCtZxlonTfLpU_5-HMuf6RdDmbJy3iMdPU",
            authDomain: "trend-vr-demo.firebaseapp.com",
            projectId: "trend-vr-demo",
            storageBucket: "trend-vr-demo.appspot.com",
            messagingSenderId: "383550694303",
            appId: "1:383550694303:web:362cf770089f4008e4d3aa"
        };
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary" id="main-nav">
        <div class="container-fluid" style="justify-content: flex-start;">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"
                style=" border: 0; ">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="#" style=" width: 100%; max-width: 150px; ">
                <svg aria-label="Pretty Little Thing" style="height:inherit;width:inherit;display:inline-block"
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 164.7 18.9">
                    <path fill="#222"
                        d="M0 .2h4c1.5 0 2.5.3 3.4 1.3.9 1 1.2 2.1 1.2 4.3 0 1.6-.1 2.7-.8 3.7-.7 1.2-1.8 2-3.8 2H2.7v7.2H0V.2zM2.7 9H4c2.2 0 2.2-1.3 2.2-3.1 0-1.7 0-3.2-2.1-3.2H2.7V9z">
                    </path>
                    <path fill="#231F20"
                        d="M10.6.2h4.3c3.2 0 4.7 1.8 4.7 5.4 0 2.1-.6 3.7-2.3 4.6l2.9 8.5h-2.8l-2.5-7.9h-1.6v7.9h-2.7V.2zm2.7 8.2h1.5c1.8 0 2.1-1 2.1-2.9s-.3-2.9-2.3-2.9h-1.4v5.8z">
                    </path>
                    <path fill="#222"
                        d="M21.9.2h7.9v2.5h-5.3v5.4h4.6v2.5h-4.6V16h5.3v2.7h-7.9V.2zM34.5 2.7h-3.1V.2h8.8v2.5h-3.1v16h-2.7v-16zM45 2.7h-3.1V.2h8.8v2.5h-3.1v16H45v-16zM55.5 10.9L51.8.2h2.8l2.1 7.4h.1L59 .2h2.8l-3.6 10.7v7.8h-2.7v-7.8zM63.7.2h2.7V16h5.3v2.7h-7.9V.2zM73.4.2H76v18.5h-2.7V.2zM80.4 2.7h-3.1V.2h8.8v2.5H83v16h-2.7v-16zM90.6 2.7h-3.1V.2h8.8v2.5h-3.1v16h-2.7v-16zM97.7.2h2.7V16h5.3v2.7h-7.9V.2zM107.4.2h7.9v2.5H110v5.4h4.6v2.5H110V16h5.3v2.7h-7.9V.2zM120.2 2.7h-3.1V.2h8.8v2.5h-3.1v16h-2.7v-16zM127.4.2h2.7v7.9h3.3V.2h2.7v18.5h-2.7v-8.3H130v8.3h-2.7V.2zM138.6.2h2.7v18.5h-2.7V.2zM144.1.2h2.6l4 11.2h.1V.2h2.7v18.5H151l-4.1-11.1h-.1v11.1h-2.7V.2zM155.8 4.5c0-3 2.3-4.5 4.5-4.5s4.5 1.5 4.5 4.5v.9H162v-.9c0-1.3-.8-1.9-1.8-1.9s-1.8.6-1.8 1.9v9.8c0 1.3.8 1.9 1.8 1.9s1.8-.6 1.8-1.9v-3.5h-2.1V8.5h4.8v5.8c0 3-2.3 4.5-4.5 4.5s-4.5-1.5-4.5-4.5V4.5z">
                    </path>
                </svg>
            </a>
            <div style=" width: 140px; display: flex; flex-direction: row-reverse; ">
                <a class="nav-link active" href="#"><img src="./assets/fakeData/pretty/search-icon.svg" alt=""
                        style="width: 20px;margin-right: 5px;"></a>
                <a class="nav-link active" href="#"><img src="./assets/fakeData/pretty/user-icon.svg" alt=""
                        style="width: 20px;margin-right: 5px;"></a>
                <a class="nav-link active" href="#"><img src="./assets/fakeData/pretty/heart-icon.svg" alt=""
                        style="width: 20px;margin-right: 5px;"></a>
                <a class="nav-link active" href="#"><img src="./assets/fakeData/pretty/store-icon.svg" alt=""
                        style="width: 20px;margin-right: 5px;"></a>
            </div>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link" href="#">Jeans</a>
                    <a class="nav-link" href="#">Tops</a>
                    <a class="nav-link" href="#">Jackets</a>
                </div>
            </div>
        </div>
    </nav>
    <!-- Preloader -->
    <div id="preloader"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <dotlottie-player src="./assets/images/image-load.lottie" background="transparent" speed="1"
            style="width: 300px; height: 300px" direction="1" playmode="normal" loop="" autoplay=""></dotlottie-player>
    </div>
    <a class="nav-link" href="#" onclick="window.history.go(-1); return false;"
        style=" display: flex; align-items: center; margin-left: 5px; margin-bottom: 10px; "><img
            src="./assets/images/back-arrow.svg" style="width: 20px;" alt=""> <span style=" margin-left: 5px; ">Go
            Back</span></a>

    <div id="product-info"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        function generateProductHTML(product, lastImage) {
            return `
            <nav aria-label="Breadcrumb" class="breadcrumb capitalize text-small-mobile tracking-widest md:text-base md:tracking-normal md:leading-normal py-4 px-2 whitespace-nowrap"><ol class="overflow-hidden"><li><a class="font-brand-thin hover:underline hover:no-underline lg:hover:underline md:leading-normal text-small-mobile md:text-base" href="/">Home</a></li><li><a class="font-brand-thin hover:underline hover:no-underline lg:hover:underline md:leading-normal text-small-mobile md:text-base" href="/clothing.html">Womens Clothing</a></li><li><a class="font-brand-thin hover:underline hover:no-underline lg:hover:underline md:leading-normal text-small-mobile md:text-base" href="/clothing/tops.html">Tops</a></li><li><a class="font-brand-thin hover:underline hover:no-underline lg:hover:underline md:leading-normal text-small-mobile md:text-base" href="/clothing/tops/nude.html">Nude Tops</a></li><li><a class="font-brand-thin hover:underline hover:no-underline lg:hover:underline md:leading-normal text-small-mobile md:text-base" href="/beige-stripe-structed-linen-look-tailored-waistcoat.html">Bei...</a></li></ol></nav>
                <div class="product-gallery">
                ${product.gallery.map(image => `<img src="${image.url}" alt="${image.alt}">`).join('')}
                </div>
                <div class="product-content">
                    <a href="#" id="generate" class="generate-ai">Try it on</a>
                    <p>${product.pricing.currency} $${product.pricing.regular_price}</del>
                    <del>${product.pricing.currency} $${product.pricing.sale_price}</p>
                    <h1>${product.name}</h1>
                    <p>${product.description}</p>
                    <h2>Colors</h2>
                    <ul>
                    ${product.colors.map(color => `<li>${color.name} (${color.hex})</li>`).join('')}
                    </ul>
                    <h2>Sizes</h2>
                    <ul>
                    ${product.sizes.map(size => `<li>${size}</li>`).join('')}
                    </ul>
                    <h2>Details</h2>
                    <ul>
                    ${product.details.material.map(material => `<li>${material}</li>`).join('')}
                    </ul>
                    <h2>Care Instructions</h2>
                    <ul>
                    ${product.details.care_instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                    </ul>
                </div>

    `;
        }

        async function generateImage(lastImageUrl, type) {
            const preloader = document.getElementById('preloader');
            const generateButton = document.getElementById('generate');
            preloader.style.display = 'flex'; // Muestra el preloader
            generateButton.style.display = 'none'; // Oculta el botón al hacer clic

            const userImageProfile = localStorage.getItem('userImageProfile');
            const url = "http://4.227.140.241:2000/trendvr-ai-service/vto/generate";
            const headers = { "Content-Type": "application/json" };
            const data = JSON.stringify({
                human_image_url: userImageProfile,
                cloth_image_url: lastImageUrl,
                body_part: type
            });

            try {
                const response = await fetch(url, { method: 'POST', headers: headers, body: data });
                const responseData = await response.json();
                if (responseData && responseData.image && responseData.score) {
                    const newImgSrc = `data:image/jpeg;base64,${responseData.image}`;
                    const score = responseData.score;
                    addGeneratedImageToGallery(newImgSrc, score);
                }
            } catch (error) {
                console.error('Error:', error);
                generateButton.style.display = 'block'; // Muestra el botón de nuevo en caso de error
            } finally {
                preloader.style.display = 'none'; // Oculta el preloader
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            async function loadProductData() {
                const { category, type, id } = getQueryParams();
                if (category && type && id) {
                    try {
                        const response = await fetch(`assets/fakeData/${category}.json`);
                        const data = await response.json();
                        const product = data.products.find(item => item.id == id);
                        if (product) {
                            const galleryLength = product.gallery.length;
                            const lastImage = galleryLength > 0 ? product.gallery[galleryLength - 1].url : '';
                            document.getElementById('product-info').innerHTML = generateProductHTML(product, lastImage);
                            addGenerateListener(type, lastImage);  // Llamar a la función para añadir el listener
                        } else {
                            document.getElementById('product-info').innerHTML = `<p>Product not found</p>`;
                        }
                    } catch (error) {
                        console.error('Error loading JSON file:', error);
                        document.getElementById('product-info').innerHTML = `<p>Error loading product data</p>`;
                    }
                } else {
                    document.getElementById('product-info').innerHTML = `<p>Invalid parameters</p>`;
                }
            }

            document.addEventListener('click', function (event) {
                console.log("clicked")
                const target = event.target;
                const parent = target.closest('div.generated-options');
                
                if (parent) {
                    console.log("clicked2")
                    if (target.id === 'ai-action-retry') {
                        console.log("clicked3")
                        const lastImage = "URL de la última imagen aquí";  // Debes obtener la última URL de la imagen
                        const type = "tipo de prenda aquí";  // Debes obtener el tipo de prenda
                        generateImage(lastImage, type);
                    } else if (target.id === 'ai-action-download') {
                        console.log("clicked4")
                        downloadImage(target.getAttribute('data-image-url'));
                    }
                }
            });

            function addGeneratedImageToGallery(imageSrc, score) {
                // Convertir la puntuación a porcentaje (score de 1 a 6)
                const scorePercentage = (score / 6) * 100;
                const scoreRounded = Math.round(scorePercentage); // Redondea al entero más cercano

                console.log('Adding generated image to gallery with score:', scoreRounded);
                const gallery = document.querySelector('.product-gallery');
                if (gallery.children.length > 0) {
                    const firstChild = gallery.children[0];
                    const newDiv = document.createElement('div');
                    newDiv.classList.add('generated-container');
                    newDiv.innerHTML = `
            <img src="${imageSrc}" alt="Generated Image">
            <span class="label" id="score-label">Your score: ${scoreRounded}%</span>
            <div class="generated-options">
                <a href='#' id="ai-action-share"><i data-feather="share"></i></a>
                <a href='#' id="ai-action-download" onclick="downloadImage('${imageSrc}')"><i data-feather="download"></i></a>
                <a href='#' id="ai-action-retry"><i data-feather="refresh-ccw"></i></a>
            </div>
        `;
                    gallery.insertBefore(newDiv, firstChild);
                    feather.replace(); // Esto reinitializa los íconos
                }
            }




            function addGenerateListener(type, lastImageUrl) {
                const generateButton = document.getElementById('generate');
                const preloader = document.getElementById('preloader');

                if (generateButton) {
                    generateButton.addEventListener('click', async (event) => {
                        preloader.style.display = 'flex'; // Muestra el preloader
                        event.preventDefault();
                        generateButton.style.display = 'none'; // Oculta el botón al hacer clic

                        const userImageProfile = localStorage.getItem('userImageProfile');

                        const url = "http://4.227.140.241:2000/trendvr-ai-service/vto/generate";
                        const headers = { "Content-Type": "application/json" };
                        const data = JSON.stringify({
                            human_image_url: userImageProfile,
                            cloth_image_url: lastImageUrl,
                            body_part: type
                        });

                        try {
                            const response = await fetch(url, { method: 'POST', headers: headers, body: data });
                            const responseData = await response.json();
                            if (responseData && responseData.image && responseData.score) {
                                const newImgSrc = `data:image/jpeg;base64,${responseData.image}`;
                                const score = responseData.score; // Suponiendo que el score es directamente utilizable
                                uploadImageToFirebase(responseData.image);
                                addGeneratedImageToGallery(newImgSrc, score);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            generateButton.style.display = 'block'; // Muestra el botón de nuevo en caso de error
                        } finally {
                            preloader.style.display = 'none'; // Oculta el preloader
                        }
                    });
                } else {
                    console.error('Generate button not found');
                }
            }


            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    category: params.get('category'),
                    type: params.get('type'),
                    id: params.get('id')
                };
            }

            loadProductData();
        });


        function uploadImageToFirebase(imageBase64) {
            // Retrieve the userID from localStorage
            var userId = localStorage.getItem('userID');

            // Check if the userId is available
            if (!userId) {
                console.error("No user ID provided");
                return;
            }

            // Remove the data URL prefix if present
            var base64Cleaned = imageBase64.replace(/^data:image\/(png|jpeg|jpg);base64,/, '');

            var byteString;
            try {
                byteString = atob(base64Cleaned);
            } catch (e) {
                console.error("Failed to decode base64 string:", e);
                return; // Stops execution if there is an error
            }

            var ab = new ArrayBuffer(byteString.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            var blob = new Blob([ab], { type: 'image/jpeg' }); // Ensure the correct type is specified

            var storage = firebase.storage();
            var storageRef = storage.ref();
            // Modify the path to include the userId
            var imageRef = storageRef.child(`users/${userId}/generated-images/${new Date().getTime()}.jpeg`);

            var uploadTask = imageRef.put(blob);

            uploadTask.on('state_changed', function (snapshot) {
                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
            }, function (error) {
                console.error('Upload failed:', error);
            }, function () {
                uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
                    console.log('File available at', downloadURL);
                });
            });
        }

        function downloadImage(imageUrl) {
            const downloadLink = document.createElement('a');
            downloadLink.href = imageUrl;
            downloadLink.download = "descarga.jpg"; // Puedes definir un nombre para el archivo descargado
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

    </script>

</body>

</html>